<form [formGroup]="echartsLineChartSettingsForm" *ngIf="echartsLineChartSettingsForm" class="apple-settings-form">
  <div class="settings-container">
    
    <!-- Design & Appearance Section (Collapsible) -->
    <div class="settings-section" [class.collapsed]="!expandedSections['design']">
      <div class="section-header" (click)="toggleSection('design')">
        <div class="section-icon design-icon">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
            <path d="M12 2L2 7V11C2 16.55 5.84 21.74 11 22.95C16.16 21.74 22 16.55 22 11V7L12 2Z" fill="currentColor" opacity="0.2"/>
            <path d="M17 8L9 16L5 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
        <div class="section-info">
          <h3 class="section-title">Design & Appearance</h3>
          <p class="section-subtitle">Customize chart visuals and layout</p>
        </div>
        <div class="section-chevron">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
            <path d="M9 6L15 12L9 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
      </div>
      
      <div class="settings-content" *ngIf="expandedSections['design']">
        <!-- Color Scheme -->
        <div class="setting-group">
          <label class="setting-label">Color Scheme</label>
          <div class="color-scheme-selector">
            <div class="color-option" 
                 [class.selected]="echartsLineChartSettingsForm.get('colorScheme')?.value === 'default'"
                 (click)="echartsLineChartSettingsForm.get('colorScheme')?.setValue('default')">
              <div class="color-preview">
                <span class="color-dot" style="background: #007aff"></span>
                <span class="color-dot" style="background: #ff9500"></span>
                <span class="color-dot" style="background: #34c759"></span>
              </div>
              <span class="color-name">Default</span>
            </div>
            <div class="color-option"
                 [class.selected]="echartsLineChartSettingsForm.get('colorScheme')?.value === 'dark'"
                 (click)="echartsLineChartSettingsForm.get('colorScheme')?.setValue('dark')">
              <div class="color-preview">
                <span class="color-dot" style="background: #1e3a8a"></span>
                <span class="color-dot" style="background: #7c2d12"></span>
                <span class="color-dot" style="background: #14532d"></span>
              </div>
              <span class="color-name">Dark</span>
            </div>
            <div class="color-option"
                 [class.selected]="echartsLineChartSettingsForm.get('colorScheme')?.value === 'vibrant'"
                 (click)="echartsLineChartSettingsForm.get('colorScheme')?.setValue('vibrant')">
              <div class="color-preview">
                <span class="color-dot" style="background: #ff006e"></span>
                <span class="color-dot" style="background: #fb5607"></span>
                <span class="color-dot" style="background: #ffbe0b"></span>
              </div>
              <span class="color-name">Vibrant</span>
            </div>
            <div class="color-option"
                 [class.selected]="echartsLineChartSettingsForm.get('colorScheme')?.value === 'pastel'"
                 (click)="echartsLineChartSettingsForm.get('colorScheme')?.setValue('pastel')">
              <div class="color-preview">
                <span class="color-dot" style="background: #ffd6ff"></span>
                <span class="color-dot" style="background: #e7c6ff"></span>
                <span class="color-dot" style="background: #c8b6ff"></span>
              </div>
              <span class="color-name">Pastel</span>
            </div>
            <div class="color-option"
                 [class.selected]="echartsLineChartSettingsForm.get('colorScheme')?.value === 'monochrome'"
                 (click)="echartsLineChartSettingsForm.get('colorScheme')?.setValue('monochrome')">
              <div class="color-preview">
                <span class="color-dot" style="background: #001f3f"></span>
                <span class="color-dot" style="background: #003366"></span>
                <span class="color-dot" style="background: #004080"></span>
              </div>
              <span class="color-name">Mono</span>
            </div>
          </div>
        </div>

        <!-- Y-Axis Label Layout -->
        <div class="setting-group">
          <label class="setting-label">Y-Axis Label Layout</label>
          <div class="segmented-control">
            <button type="button" class="segment"
                    [class.active]="echartsLineChartSettingsForm.get('yAxisLabelLines')?.value === 1"
                    (click)="echartsLineChartSettingsForm.get('yAxisLabelLines')?.setValue(1)">
              1 Line
            </button>
            <button type="button" class="segment"
                    [class.active]="echartsLineChartSettingsForm.get('yAxisLabelLines')?.value === 2"
                    (click)="echartsLineChartSettingsForm.get('yAxisLabelLines')?.setValue(2)">
              2 Lines
            </button>
            <button type="button" class="segment"
                    [class.active]="echartsLineChartSettingsForm.get('yAxisLabelLines')?.value === 3"
                    (click)="echartsLineChartSettingsForm.get('yAxisLabelLines')?.setValue(3)">
              3 Lines
            </button>
          </div>
        </div>

        <!-- Toggle Settings -->
        <div class="toggle-group">
          <div class="toggle-row">
            <label class="toggle-label">Smooth Lines</label>
            <label class="apple-switch">
              <input type="checkbox" formControlName="smooth">
              <span class="slider"></span>
            </label>
          </div>
          <div class="toggle-row">
            <label class="toggle-label">Show Data Points</label>
            <label class="apple-switch">
              <input type="checkbox" formControlName="showDataPoints">
              <span class="slider"></span>
            </label>
          </div>
          <div class="toggle-row" *ngIf="echartsLineChartSettingsForm.get('showDataPoints')?.value">
            <label class="toggle-label">Point Size: {{echartsLineChartSettingsForm.get('symbolSize_data')?.value}}</label>
            <input type="range" class="apple-slider" min="1" max="15" step="1" formControlName="symbolSize_data">
          </div>
          <div class="toggle-row">
            <label class="toggle-label">Line Thickness: {{echartsLineChartSettingsForm.get('lineWidth')?.value}}</label>
            <input type="range" class="apple-slider" min="1" max="10" step="0.5" formControlName="lineWidth">
          </div>
          <div class="toggle-row">
            <label class="toggle-label">Show Legend</label>
            <label class="apple-switch">
              <input type="checkbox" formControlName="showlegend">
              <span class="slider"></span>
            </label>
          </div>
          <div class="toggle-row">
            <label class="toggle-label">Multiple Devices Mode</label>
            <label class="apple-switch">
              <input type="checkbox" formControlName="multipleDevices">
              <span class="slider"></span>
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- Sidebar Section (Collapsible) -->
    <div class="settings-section" [class.collapsed]="!expandedSections['sidebar']">
      <div class="section-header" (click)="toggleSection('sidebar')">
        <div class="section-icon sidebar-icon">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
            <rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2"/>
            <line x1="9" y1="3" x2="9" y2="21" stroke="currentColor" stroke-width="2"/>
            <circle cx="6" cy="8" r="1" fill="currentColor"/>
            <circle cx="6" cy="12" r="1" fill="currentColor"/>
            <circle cx="6" cy="16" r="1" fill="currentColor"/>
          </svg>
        </div>
        <div class="section-info">
          <h3 class="section-title">Sidebar</h3>
          <p class="section-subtitle">Configure sidebar behavior</p>
        </div>
        <div class="section-chevron">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
            <path d="M9 6L15 12L9 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
      </div>
      
      <div class="settings-content" *ngIf="expandedSections['sidebar']">
        <!-- Sidebar Collapsed Mode -->
        <div class="setting-group">
          <label class="setting-label">When Collapsed</label>
          <p class="setting-description">How the sidebar appears when minimized</p>
          <div class="segmented-control">
            <button type="button" class="segment"
                    [class.active]="echartsLineChartSettingsForm.get('sidebarCollapsedMode')?.value === 'hidden'"
                    (click)="echartsLineChartSettingsForm.get('sidebarCollapsedMode')?.setValue('hidden')">
              Hidden
            </button>
            <button type="button" class="segment"
                    [class.active]="echartsLineChartSettingsForm.get('sidebarCollapsedMode')?.value === 'colors'"
                    (click)="echartsLineChartSettingsForm.get('sidebarCollapsedMode')?.setValue('colors')">
              Colors
            </button>
          </div>
        </div>
        
        <!-- Sidebar Display Mode -->
        <div class="setting-group">
          <label class="setting-label">Display Mode</label>
          <p class="setting-description">How entities are shown in the sidebar</p>
          <div class="segmented-control">
            <button type="button" class="segment"
                    [class.active]="echartsLineChartSettingsForm.get('sidebarDisplayMode')?.value === 'full'"
                    (click)="echartsLineChartSettingsForm.get('sidebarDisplayMode')?.setValue('full')">
              Full
            </button>
            <button type="button" class="segment"
                    [class.active]="echartsLineChartSettingsForm.get('sidebarDisplayMode')?.value === 'compact'"
                    (click)="echartsLineChartSettingsForm.get('sidebarDisplayMode')?.setValue('compact')">
              Compact
            </button>
            <button type="button" class="segment"
                    [class.active]="echartsLineChartSettingsForm.get('sidebarDisplayMode')?.value === 'colors'"
                    (click)="echartsLineChartSettingsForm.get('sidebarDisplayMode')?.setValue('colors')">
              Colors
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Grid Layout (Collapsible) -->
    <div class="settings-section" [class.collapsed]="!expandedSections['grid']">
      <div class="section-header" (click)="toggleSection('grid')">
        <div class="section-icon grid-icon">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
            <rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2"/>
            <line x1="3" y1="9" x2="21" y2="9" stroke="currentColor" stroke-width="2"/>
            <line x1="3" y1="15" x2="21" y2="15" stroke="currentColor" stroke-width="2"/>
            <line x1="9" y1="3" x2="9" y2="21" stroke="currentColor" stroke-width="2"/>
            <line x1="15" y1="3" x2="15" y2="21" stroke="currentColor" stroke-width="2"/>
          </svg>
        </div>
        <div class="section-info">
          <h3 class="section-title">Grid Layout</h3>
          <p class="section-subtitle">Adjust chart grid margins and spacing</p>
        </div>
        <div class="section-chevron">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
            <path d="M9 6L15 12L9 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
      </div>
      
      <div class="settings-content" *ngIf="expandedSections['grid']">
        <div class="grid-inputs">
          <div class="input-group">
            <label class="input-label">Top Margin</label>
            <input type="number" class="apple-input" formControlName="grid_layout_top" placeholder="40">
          </div>
          <div class="input-group">
            <label class="input-label">Bottom Margin</label>
            <input type="number" class="apple-input" formControlName="grid_layout_bottom" placeholder="240">
          </div>
          <div class="input-group">
            <label class="input-label">Left Margin</label>
            <input type="number" class="apple-input" formControlName="grid_layout_left" placeholder="130">
          </div>
          <div class="input-group">
            <label class="input-label">Right Margin</label>
            <input type="number" class="apple-input" formControlName="grid_layout_right" placeholder="40">
          </div>
          <div class="input-group">
            <label class="input-label">Scrolling Starts After (plots)</label>
            <input type="number" class="apple-input" formControlName="scrollingStartsAfter" placeholder="3">
          </div>
        </div>
      </div>
    </div>

    <!-- Tooltip Settings (Collapsible) -->
    <div class="settings-section" [class.collapsed]="!expandedSections['tooltip']">
      <div class="section-header" (click)="toggleSection('tooltip')">
        <div class="section-icon tooltip-icon">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
            <rect x="4" y="6" width="16" height="12" rx="2" stroke="currentColor" stroke-width="2"/>
            <path d="M8 10H16M8 14H12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
        <div class="section-info">
          <h3 class="section-title">Tooltip Settings</h3>
          <p class="section-subtitle">Configure tooltip behavior and display</p>
        </div>
        <div class="section-chevron">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
            <path d="M9 6L15 12L9 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
      </div>
      
      <div class="settings-content" *ngIf="expandedSections['tooltip']">
        <div class="toggle-row">
          <label class="toggle-label">Only Show Hovered Grid</label>
          <label class="apple-switch">
            <input type="checkbox" formControlName="tooltipOnlyHoveredGrid">
            <span class="slider"></span>
          </label>
        </div>
        <div class="input-group">
          <label class="input-label">Max Items to Display</label>
          <input type="number" class="apple-input" formControlName="tooltipMaxItems" placeholder="10">
        </div>
        <div class="input-group">
          <label class="input-label">Show All if Series Count â‰¤</label>
          <input type="number" class="apple-input" formControlName="tooltipShowAllIfSeriesCountLTE" placeholder="0">
        </div>
        
        <!-- Tooltip Label Format -->
        <div class="setting-group">
          <label class="setting-label">Tooltip Label Format</label>
          <p class="setting-description">Customize how labels appear in tooltips</p>
          <div class="segmented-control">
            <button type="button" class="segment"
                    [class.active]="echartsLineChartSettingsForm.get('tooltipLabelPreset')?.value === 'default'"
                    (click)="echartsLineChartSettingsForm.get('tooltipLabelPreset')?.setValue('default')">
              Default
            </button>
            <button type="button" class="segment"
                    [class.active]="echartsLineChartSettingsForm.get('tooltipLabelPreset')?.value === 'compact'"
                    (click)="echartsLineChartSettingsForm.get('tooltipLabelPreset')?.setValue('compact')">
              Compact
            </button>
            <button type="button" class="segment"
                    [class.active]="echartsLineChartSettingsForm.get('tooltipLabelPreset')?.value === 'detailed'"
                    (click)="echartsLineChartSettingsForm.get('tooltipLabelPreset')?.setValue('detailed')">
              Detailed
            </button>
            <button type="button" class="segment"
                    [class.active]="echartsLineChartSettingsForm.get('tooltipLabelPreset')?.value === 'custom'"
                    (click)="echartsLineChartSettingsForm.get('tooltipLabelPreset')?.setValue('custom')">
              Custom
            </button>
          </div>
        </div>
        
        <!-- Custom Format Input -->
        <div class="input-group" *ngIf="echartsLineChartSettingsForm.get('tooltipLabelPreset')?.value === 'custom'">
          <label class="input-label">Custom Format</label>
          <input type="text" class="apple-input" formControlName="tooltipLabelFormat" 
                 placeholder="e.g., {{ '{' }}device.limit(20){{ '}' }} | {{ '{' }}label{{ '}' }}: {{ '{' }}value{{ '}' }}">
          <div class="format-help">
            <small class="help-text">Available variables:</small>
            <ul class="help-list">
              <li><code>{{ '{' }}device{{ '}' }}</code> - Device display name</li>
              <li><code>{{ '{' }}deviceName{{ '}' }}</code> - Device name attribute</li>
              <li><code>{{ '{' }}deviceId{{ '}' }}</code> - Device UUID</li>
              <li><code>{{ '{' }}label{{ '}' }}</code> - Series label</li>
              <li><code>{{ '{' }}value{{ '}' }}</code> - Data value</li>
              <li><code>{{ '{' }}unit{{ '}' }}</code> - Unit (if available)</li>
              <li><code>.limit(n)</code> - Limit to n characters</li>
            </ul>
            <small class="help-text">Examples:</small>
            <ul class="help-list">
              <li><code>{{ '{' }}device.limit(10){{ '}' }} | {{ '{' }}label{{ '}' }}</code></li>
              <li><code>[{{ '{' }}device{{ '}' }}] {{ '{' }}label{{ '}' }}: {{ '{' }}value{{ '}' }}</code></li>
              <li><code>{{ '{' }}label{{ '}' }} ({{ '{' }}deviceName{{ '}' }}): {{ '{' }}value{{ '}' }}</code></li>
              <li><code>{{ '{' }}device{{ '}' }} ({{ '{' }}deviceId.limit(8){{ '}' }})</code></li>
            </ul>
          </div>
        </div>
        
        <!-- Format Preview -->
        <div class="preview-box" *ngIf="echartsLineChartSettingsForm.get('tooltipLabelPreset')?.value !== 'custom'">
          <label class="preview-label">Format Preview:</label>
          <div class="preview-content">
            {{ getTooltipPresetFormat() }}
          </div>
        </div>
      </div>
    </div>

    <!-- Export Settings (Collapsible) -->
    <div class="settings-section" [class.collapsed]="!expandedSections['export']">
      <div class="section-header" (click)="toggleSection('export')">
        <div class="section-icon export-icon">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
            <path d="M12 3V15M12 15L8 11M12 15L16 11" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M3 17V19C3 20.1046 3.89543 21 5 21H19C20.1046 21 21 20.1046 21 19V17" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
        <div class="section-info">
          <h3 class="section-title">Export Settings</h3>
          <p class="section-subtitle">Configure data export options</p>
        </div>
        <div class="section-chevron">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
            <path d="M9 6L15 12L9 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
      </div>
      
      <div class="settings-content" *ngIf="expandedSections['export']">
        <div class="input-group">
          <label class="input-label">Decimal Places</label>
          <input type="number" class="apple-input" formControlName="exportDecimals" min="0" max="10" placeholder="6">
        </div>
        <div class="toggle-row">
          <label class="toggle-label">Show Pan/Zoom Tool</label>
          <label class="apple-switch">
            <input type="checkbox" formControlName="showPanZoomTool">
            <span class="slider"></span>
          </label>
        </div>
      </div>
    </div>

    <!-- Min/Max Reference Lines (Always Expanded) -->
    <div class="settings-section">
      <div class="section-header">
        <div class="section-icon minmax-icon">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
            <path d="M3 12H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-dasharray="4 2"/>
            <path d="M3 6H21" stroke="#007aff" stroke-width="2" stroke-linecap="round"/>
            <path d="M3 18H21" stroke="#ff3b30" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
        <div class="section-info">
          <h3 class="section-title">Min/Max Reference Lines</h3>
          <p class="section-subtitle">Show global minimum and maximum values</p>
        </div>
      </div>
      
      <div class="settings-content">
        <div class="toggle-row">
          <label class="toggle-label">Enable Min/Max Lines</label>
          <label class="apple-switch">
            <input type="checkbox" formControlName="minMaxVisible">
            <span class="slider"></span>
          </label>
        </div>
        
        <div class="toggle-row">
          <label class="toggle-label">Show Min/Max Control in Dialog</label>
          <label class="apple-switch">
            <input type="checkbox" formControlName="showMinMaxInDialog">
            <span class="slider"></span>
          </label>
        </div>
        
        <div class="subsettings" *ngIf="echartsLineChartSettingsForm.get('minMaxVisible')?.value">
          <div class="setting-group">
            <label class="setting-label">Line Style</label>
            <div class="segmented-control">
              <button type="button" class="segment"
                      [class.active]="echartsLineChartSettingsForm.get('minMaxStyle')?.value === 'dashed'"
                      (click)="echartsLineChartSettingsForm.get('minMaxStyle')?.setValue('dashed')">
                <svg width="24" height="2" viewBox="0 0 24 2">
                  <path d="M0 1H5 M8 1H13 M16 1H21" stroke="currentColor" stroke-width="2"/>
                </svg>
              </button>
              <button type="button" class="segment"
                      [class.active]="echartsLineChartSettingsForm.get('minMaxStyle')?.value === 'solid'"
                      (click)="echartsLineChartSettingsForm.get('minMaxStyle')?.setValue('solid')">
                <svg width="24" height="2" viewBox="0 0 24 2">
                  <path d="M0 1H24" stroke="currentColor" stroke-width="2"/>
                </svg>
              </button>
              <button type="button" class="segment"
                      [class.active]="echartsLineChartSettingsForm.get('minMaxStyle')?.value === 'dotted'"
                      (click)="echartsLineChartSettingsForm.get('minMaxStyle')?.setValue('dotted')">
                <svg width="24" height="2" viewBox="0 0 24 2">
                  <path d="M0 1H1 M3 1H4 M6 1H7 M9 1H10 M12 1H13" stroke="currentColor" stroke-width="2"/>
                </svg>
              </button>
            </div>
          </div>
          
          <div class="setting-group">
            <label class="setting-label">Line Width: {{echartsLineChartSettingsForm.get('minMaxLineWidth')?.value}}px</label>
            <input type="range" class="apple-slider" min="1" max="5" step="1" formControlName="minMaxLineWidth">
          </div>
        </div>
      </div>
    </div>

    <!-- Alarm Support (Always Expanded) -->
    <div class="settings-section">
      <div class="section-header">
        <div class="section-icon alarm-icon">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
            <path d="M12 2L2 7V11C2 16.55 5.84 21.74 11 22.95C16.16 21.74 22 16.55 22 11V7L12 2Z" 
                  fill="#ff3b30" opacity="0.2"/>
            <path d="M12 9V13M12 17H12.01" stroke="#ff3b30" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
        <div class="section-info">
          <h3 class="section-title">Alarm Support</h3>
          <p class="section-subtitle">Configure alarm visualization features</p>
        </div>
      </div>
      
      <div class="settings-content">
        <div class="toggle-row">
          <label class="toggle-label">Enable Alarm Support</label>
          <label class="apple-switch">
            <input type="checkbox" formControlName="alarmSupportEnabled">
            <span class="slider"></span>
          </label>
        </div>
        
        <div class="subsettings" *ngIf="echartsLineChartSettingsForm.get('alarmSupportEnabled')?.value">
          <!-- Alarm Lines Section -->
          <div class="subsection-header" (click)="toggleSubsection('alarmLines')">
            <h4 class="subsection-title">Alarm Lines</h4>
            <div class="subsection-chevron" [class.rotated]="expandedSubsections['alarmLines']">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                <path d="M9 6L15 12L9 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
          </div>
          
          <div class="subsection-content" *ngIf="expandedSubsections['alarmLines']">
            <div class="toggle-row">
              <label class="toggle-label">Enable by Default</label>
              <label class="apple-switch">
                <input type="checkbox" formControlName="alarmLinesVisible">
                <span class="slider"></span>
              </label>
            </div>
            
            <div class="toggle-row">
              <label class="toggle-label">Show Control in Dialog</label>
              <label class="apple-switch">
                <input type="checkbox" formControlName="showAlarmLinesInDialog">
                <span class="slider"></span>
              </label>
            </div>
          </div>
          
          <!-- Alarm Overlays Section -->
          <div class="subsection-header" (click)="toggleSubsection('alarmOverlays')">
            <h4 class="subsection-title">Alarm Overlays</h4>
            <div class="subsection-chevron" [class.rotated]="expandedSubsections['alarmOverlays']">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                <path d="M9 6L15 12L9 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
          </div>
          
          <div class="subsection-content" *ngIf="expandedSubsections['alarmOverlays']">
            <div class="toggle-row">
              <label class="toggle-label">Enable by Default</label>
              <label class="apple-switch">
                <input type="checkbox" formControlName="alarmStatusVisible">
                <span class="slider"></span>
              </label>
            </div>
            
            <div class="toggle-row">
              <label class="toggle-label">Show Control in Dialog</label>
              <label class="apple-switch">
                <input type="checkbox" formControlName="showAlarmOverlayInDialog">
                <span class="slider"></span>
              </label>
            </div>
            
            <div class="setting-group" *ngIf="echartsLineChartSettingsForm.get('alarmStatusVisible')?.value">
              <label class="setting-label">Opacity: {{Math.round((echartsLineChartSettingsForm.get('alarmOpacity')?.value || 0.12) * 100)}}%</label>
              <input type="range" class="apple-slider" min="0.05" max="0.3" step="0.01" formControlName="alarmOpacity">
            </div>
            
            <div class="checkbox-group" *ngIf="echartsLineChartSettingsForm.get('alarmStatusVisible')?.value">
              <label class="apple-checkbox">
                <input type="checkbox" formControlName="alarmShowCritical">
                <span class="checkbox-box"></span>
                <span class="checkbox-label">
                  <span class="severity-dot critical"></span>
                  Critical Alarms
                </span>
              </label>
              <label class="apple-checkbox">
                <input type="checkbox" formControlName="alarmShowWarning">
                <span class="checkbox-box"></span>
                <span class="checkbox-label">
                  <span class="severity-dot warning"></span>
                  Warning Alarms
                </span>
              </label>
              <label class="apple-checkbox">
                <input type="checkbox" formControlName="alarmShowInfo">
                <span class="checkbox-box"></span>
                <span class="checkbox-label">
                  <span class="severity-dot info"></span>
                  Info Alarms
                </span>
              </label>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- UI Elements (Collapsible) -->
    <div class="settings-section" [class.collapsed]="!expandedSections['ui']">
      <div class="section-header" (click)="toggleSection('ui')">
        <div class="section-icon ui-icon">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
            <rect x="3" y="3" width="8" height="8" rx="1" stroke="currentColor" stroke-width="2"/>
            <rect x="13" y="3" width="8" height="8" rx="1" stroke="currentColor" stroke-width="2"/>
            <rect x="3" y="13" width="8" height="8" rx="1" stroke="currentColor" stroke-width="2"/>
            <rect x="13" y="13" width="8" height="8" rx="1" stroke="currentColor" stroke-width="2"/>
          </svg>
        </div>
        <div class="section-info">
          <h3 class="section-title">UI Elements</h3>
          <p class="section-subtitle">Control visibility of interface components</p>
        </div>
        <div class="section-chevron">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
            <path d="M9 6L15 12L9 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
      </div>
      
      <div class="settings-content" *ngIf="expandedSections['ui']">
        <div class="toggle-group">
          <div class="toggle-row">
            <label class="toggle-label">Image Button</label>
            <label class="apple-switch">
              <input type="checkbox" formControlName="showImageButton">
              <span class="slider"></span>
            </label>
          </div>
          <div class="toggle-row">
            <label class="toggle-label">Export Button</label>
            <label class="apple-switch">
              <input type="checkbox" formControlName="showExportButton">
              <span class="slider"></span>
            </label>
          </div>
          <div class="toggle-row">
            <label class="toggle-label">Reset Zoom Button</label>
            <label class="apple-switch">
              <input type="checkbox" formControlName="showResetZoomButton">
              <span class="slider"></span>
            </label>
          </div>
          <div class="toggle-row">
            <label class="toggle-label">Entity Sidebar</label>
            <label class="apple-switch">
              <input type="checkbox" formControlName="showEntitySidebar">
              <span class="slider"></span>
            </label>
          </div>
          <div class="toggle-row">
            <label class="toggle-label">Custom Legend</label>
            <label class="apple-switch">
              <input type="checkbox" formControlName="showCustomLegend">
              <span class="slider"></span>
            </label>
          </div>
          <div class="toggle-row">
            <label class="toggle-label">Zoom Controls</label>
            <label class="apple-switch">
              <input type="checkbox" formControlName="showZoomControls">
              <span class="slider"></span>
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- Performance (Collapsible) -->
    <div class="settings-section" [class.collapsed]="!expandedSections['performance']">
      <div class="section-header" (click)="toggleSection('performance')">
        <div class="section-icon perf-icon">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
            <path d="M13 2.05V12H22.95C22.45 17 18.03 21 12.94 21C7.85 21 3.58 16.73 3.08 11.64L3.05 11.37C3.05 6.29 7.34 2 12.42 2C12.61 2 12.79 2.02 12.97 2.05H13Z" fill="currentColor" opacity="0.2"/>
            <path d="M12 2V12H22" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
        <div class="section-info">
          <h3 class="section-title">Performance</h3>
          <p class="section-subtitle">Optimize chart rendering and responsiveness</p>
        </div>
        <div class="section-chevron">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
            <path d="M9 6L15 12L9 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
      </div>
      
      <div class="settings-content" *ngIf="expandedSections['performance']">
        <div class="toggle-group">
          <div class="toggle-row">
            <label class="toggle-label">Lazy Loading</label>
            <label class="apple-switch">
              <input type="checkbox" formControlName="useLazyLoading">
              <span class="slider"></span>
            </label>
          </div>
          <div class="toggle-row">
            <label class="toggle-label">Animations</label>
            <label class="apple-switch">
              <input type="checkbox" formControlName="enableAnimations">
              <span class="slider"></span>
            </label>
          </div>
          <div class="toggle-row">
            <label class="toggle-label">Data Sampling</label>
            <label class="apple-switch">
              <input type="checkbox" formControlName="enableDataSampling">
              <span class="slider"></span>
            </label>
          </div>
          <div class="input-group" *ngIf="echartsLineChartSettingsForm.get('enableDataSampling')?.value">
            <label class="input-label">Max Data Points</label>
            <input type="number" class="apple-input" formControlName="maxDataPoints" placeholder="10000">
          </div>
          <div class="toggle-row">
            <label class="toggle-label">Progressive Rendering</label>
            <label class="apple-switch">
              <input type="checkbox" formControlName="enableProgressiveRendering">
              <span class="slider"></span>
            </label>
          </div>
          <div class="toggle-row">
            <label class="toggle-label">Optimize Click Handling</label>
            <label class="apple-switch">
              <input type="checkbox" formControlName="optimizeClickHandling">
              <span class="slider"></span>
            </label>
          </div>
          <div class="toggle-row">
            <label class="toggle-label">Deferred UI Updates</label>
            <label class="apple-switch">
              <input type="checkbox" formControlName="deferredUIUpdates">
              <span class="slider"></span>
            </label>
          </div>
          <div class="toggle-row">
            <label class="toggle-label">Batch ECharts Updates</label>
            <label class="apple-switch">
              <input type="checkbox" formControlName="batchEChartsUpdates">
              <span class="slider"></span>
            </label>
          </div>
          <div class="toggle-row">
            <label class="toggle-label">Canvas Renderer</label>
            <label class="apple-switch">
              <input type="checkbox" formControlName="useCanvasRenderer">
              <span class="slider"></span>
            </label>
          </div>
          <div class="toggle-row">
            <label class="toggle-label">Debug Output</label>
            <label class="apple-switch">
              <input type="checkbox" formControlName="debugOutput">
              <span class="slider"></span>
            </label>
          </div>
          
          <!-- Debug Logging Configuration -->
          <div class="subsection">
            <h4 class="subsection-title">Debug Logging Configuration</h4>
            <p class="setting-description">Configure which types of debug logs to enable for troubleshooting</p>
            <button type="button" class="debug-config-button" (click)="openDebugLoggingDialog()">
              <div class="button-icon">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                  <path d="M10.5 6L9.5 4H4.5L3.5 6V18L4.5 20H19.5L20.5 18V6L19.5 4H14.5L13.5 6H10.5Z" stroke="currentColor" stroke-width="2" fill="none"/>
                  <path d="M9 12L11 14L15 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </div>
              <span>Configure Debug Logs</span>
              <div class="button-arrow">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none">
                  <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </div>
            </button>
            <div class="debug-status" *ngIf="echartsLineChartSettingsForm.get('debugNormalLogs')?.value || 
                                              echartsLineChartSettingsForm.get('debugPerformanceLogs')?.value || 
                                              echartsLineChartSettingsForm.get('debugMinMaxLogs')?.value || 
                                              echartsLineChartSettingsForm.get('debugAlarmLogs')?.value">
              <div class="status-indicator active"></div>
              <span class="status-text">Debug logging is active</span>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</form>